using System.Security.Cryptography;
using AesXGcmDotNet;
using Microsoft.VisualStudio.TestTools.UnitTesting;

namespace AesXGcmDotNetTests;

[TestClass]
public class AesXGcmTests
{
    [TestMethod]
    [DataRow("00000000000000000000000000000000", "100002000000000000000000000000000000000000000000000000", "1001000000000000000000000000000000000000000000000000000000000000", "00000000000000000000000000000000", "84c57de54734b021c829262d33aabd6f81eb22f3c501a0efb66a286552486b78")]
    [DataRow("00000000000000000000000000000000", "100002000000000000000000000000000000000000000000000001", "1001000000000000000000000000000000000000000000000000000000000000", "00000000000000000000000000000000", "cc2c8a824f1b5b7df16086715f0b4e3b134460927053e86d0279db3e743e4217")]
    [DataRow("00000000000000000000000000000000", "100002000000000000000000000000000000000000000000000000", "1001000000000000000000000000000000000000000000000000000000000001", "00000000000000000000000000000000", "0950a2d36545eb2f03856f5cd6d1c7409f91df3479fe29da0effcda4e701f9c9")]
    [DataRow("000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f", "fc38ee4ef8c8d15db00083baa396a67e41013208b8422549da2152", "1b557784ebf9c5072a08b4ef0d2e328cb338fc366067897f107c1708535147a9", "32b7a94d87760527301a72eb4e388931", "c4b4ac3c1a9c187292b83b6b65dff2057df6b4d26fec7fd077bee178aa1e4c3bc38394ebcbb325839426192ac9ade9b0")]
    [DataRow("000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f", "fc38ee4ef8c8d15db00083baa396a67e41013208b8422549da2152", "1b557784ebf9c5072a08b4ef0d2e328cb338fc366067897f107c1708535147a9", "", "c4b4ac3c1a9c187292b83b6b65dff2057df6b4d26fec7fd077bee178aa1e4c3bef061ce1c7fb5ef15ad7da083ace332d")]
    public void SuccessTestVectors(string plaintext, string nonce, string key, string associatedData, string ciphertext)
    {
        Span<byte> p = Convert.FromHexString(plaintext);
        Span<byte> n = Convert.FromHexString(nonce);
        Span<byte> k = Convert.FromHexString(key);
        Span<byte> a = Convert.FromHexString(associatedData);
        Span<byte> c = stackalloc byte[p.Length + AesXGcm.TagSize];
        
        AesXGcm.Encrypt(c, p, n, k, a);
        Assert.AreEqual(ciphertext, Convert.ToHexString(c).ToLower());
        
        Span<byte> m = stackalloc byte[p.Length];
        AesXGcm.Decrypt(m, c, n, k, a);
        Assert.IsTrue(m.SequenceEqual(p));
    }
    
    [TestMethod]
    [DataRow("84c57de54734b021c829262d33aabd6f81eb22f3c501a0efb66a286552486b79", "100002000000000000000000000000000000000000000000000000", "1001000000000000000000000000000000000000000000000000000000000000", "00000000000000000000000000000000")]
    [DataRow("cc2c8a824f1b5b7df16086715f0b4e3b134460927053e86d0279db3e743e4217", "200002000000000000000000000000000000000000000000000001", "1001000000000000000000000000000000000000000000000000000000000000", "00000000000000000000000000000000")]
    [DataRow("cc2c8a824f1b5b7df16086715f0b4e3b134460927053e86d0279db3e743e4217", "100002000000000000000000000000000000000000000000000002", "1001000000000000000000000000000000000000000000000000000000000000", "00000000000000000000000000000000")]
    [DataRow("0950a2d36545eb2f03856f5cd6d1c7409f91df3479fe29da0effcda4e701f9c9", "100002000000000000000000000000000000000000000000000000", "1001000000000000000000000000000000000000000000000000000000000002", "00000000000000000000000000000000")]
    [DataRow("c4b4ac3c1a9c187292b83b6b65dff2057df6b4d26fec7fd077bee178aa1e4c3bc38394ebcbb325839426192ac9ade9b0", "fc38ee4ef8c8d15db00083baa396a67e41013208b8422549da2152", "1b557784ebf9c5072a08b4ef0d2e328cb338fc366067897f107c1708535147a9", "32b7a94d87760527301a72eb4e388932")]
    public void ErrorTestVectors(string ciphertext, string nonce, string key, string associatedData)
    {
        var c = Convert.FromHexString(ciphertext);
        var n = Convert.FromHexString(nonce);
        var k = Convert.FromHexString(key);
        var a = Convert.FromHexString(associatedData);
        var p = new byte[c.Length - AesXGcm.TagSize];
        Assert.ThrowsException<CryptographicException>(() => AesXGcm.Decrypt(p, c, n, k, a));
    }
}